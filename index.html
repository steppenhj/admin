<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>학교 식당 예약 시스템</title>
  <style>
    :root { --bg:#f9f9f9; --card-bg:#fff; --text:#333; --accent:#4CAF50; --border:#ccc; }
    body { font-family:'Segoe UI', Tahoma, sans-serif; text-align:center; margin:20px; background:var(--bg); color:var(--text); }
    h1 { margin-bottom:20px; }
    .container { max-width:400px; margin:auto; padding:20px; background:var(--card-bg); border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    label { display:block; text-align:left; margin-top:15px; font-weight:bold; }
    select, input[type="date"], button { width:100%; padding:10px; margin-top:8px; font-size:16px; border:1px solid var(--border); border-radius:4px; background:var(--bg); color:var(--text); }
    button { background:var(--accent); color:#fff; border:none; cursor:pointer; margin-top:20px; }
    button:disabled { background:#999; cursor:default; }
    #qrcode { margin-top:20px; min-height:200px; }
    .info { margin-top:8px; font-size:14px; color:var(--text); text-align:left; }
    #authLink { position:fixed; top:20px; right:20px; text-decoration:none; color:var(--text); border:1px solid var(--border); border-radius:4px; padding:5px 10px; background:var(--card-bg); z-index:1000; }
  </style>
</head>
<body>
  <a id="authLink" href="login.html">로그인/회원가입</a>
  <h1>학교 식당 예약 시스템</h1>
  <div class="container">
    <label for="date">날짜 (오늘만 선택 가능):</label>
    <input type="date" id="date" disabled />
    <p class="info">※ 예약 시간 30분 안에 오지 않으면 예약이 취소됩니다.</p>

    <label for="timeslot">시간대 선택:</label>
    <select id="timeslot">
      <option value="11:00~11:30">11:00~11:30</option>
      <option value="11:30~12:00">11:30~12:00</option>
      <option value="12:00~12:30">12:00~12:30</option>
      <option value="12:30~13:00">12:30~13:00</option>
    </select>

    <div class="info" id="menuStock">
      <!-- 메뉴별 잔여량 표시 -->
    </div>

    <label for="menu">메뉴 선택:</label>
    <select id="menu">
      <option value="비빔밥">비빔밥</option>
      <option value="된장찌개">된장찌개</option>
      <option value="카레라이스">카레라이스</option>
    </select>

    <button id="reserveBtn">예약 및 QR 발급</button>
    <div id="qrcode"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    const TODAY = (() => { const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; })();
    document.getElementById('date').value = TODAY;

    const initialStock = {
      '11:00~11:30': { '비빔밥':20, '된장찌개':20, '카레라이스':20 },
      '11:30~12:00': { '비빔밥':20, '된장찌개':20, '카레라이스':20 },
      '12:00~12:30': { '비빔밥':20, '된장찌개':20, '카레라이스':20 },
      '12:30~13:00': { '비빔밥':20, '된장찌개':20, '카레라이스':20 }
    };

    const timeslotSelect = document.getElementById('timeslot');
    const menuStockDiv = document.getElementById('menuStock');
    const menuSelect = document.getElementById('menu');
    const reserveBtn = document.getElementById('reserveBtn');
    const qrContainer = document.getElementById('qrcode');

    function formatMenuKey(date, timeslot, menu) {
      return `${date}__${timeslot}__${menu}`;
    }
    function getReservedMenuCount(key) {
      return parseInt(localStorage.getItem(key)||'0',10);
    }
    function updateMenuStock() {
      const timeslot = timeslotSelect.value;
      let html = '';
      Object.keys(initialStock[timeslot]).forEach(menu => {
        const key = formatMenuKey(TODAY, timeslot, menu);
        const reserved = getReservedMenuCount(key);
        const left = initialStock[timeslot][menu] - reserved;
        html += `${menu}: ${left}개 남음<br>`;
      });
      menuStockDiv.innerHTML = html;
      // 예약 가능 여부 판단
      const menuLeft = initialStock[timeslot][menuSelect.value] - getReservedMenuCount(formatMenuKey(TODAY, timeslot, menuSelect.value));
      reserveBtn.disabled = menuLeft <= 0;
    }

    timeslotSelect.addEventListener('change', updateMenuStock);
    menuSelect.addEventListener('change', updateMenuStock);

    reserveBtn.addEventListener('click', () => {
      const timeslot = timeslotSelect.value;
      const menu = menuSelect.value;
      const key = formatMenuKey(TODAY, timeslot, menu);
      const prev = getReservedMenuCount(key);
      localStorage.setItem(key, prev+1);
      // QR 생성: 시간|메뉴
      qrContainer.innerHTML = '';
      new QRCode(qrContainer, { text:`${TODAY}|${timeslot}|${menu}`, width:200, height:200 });
      alert('예약이 완료되었습니다!');
      updateMenuStock();
    });

    // 초기 표시
    updateMenuStock();
  </script>
</body>
</html>
